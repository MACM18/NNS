// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// USER & AUTHENTICATION
// ==========================================
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String?   // Hashed password (null for OAuth users)
  emailVerified DateTime?
  
  // Two-Factor Authentication
  twoFactorEnabled     Boolean   @default(false) @map("two_factor_enabled")
  twoFactorSecret      String?   @map("two_factor_secret") // Encrypted TOTP secret
  twoFactorBackupCodes Json?     @map("two_factor_backup_codes") // Array of hashed backup codes
  
  // Password Security
  lastPasswordChange   DateTime? @map("last_password_change")
  passwordExpireWarned Boolean   @default(false) @map("password_expire_warned")
  
  // Account Security
  loginAttempts        Int       @default(0) @map("login_attempts")
  accountLockedUntil   DateTime? @map("account_locked_until")
  
  // Relationships
  profile       Profile?
  accounts      Account[]
  sessions      Session[]
  notifications Notification[]
  lineEntries   LineEntry[]
  loginHistory  LoginHistory[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ==========================================
// PROFILES (Application-level user data)
// ==========================================
model Profile {
  id        String   @id @default(uuid())
  userId    String   @unique
  email     String?
  fullName  String?  @map("full_name")
  phone     String?  @map("phone")
  address   String?  @map("address")
  bio       String?  @map("bio")
  avatarUrl String?  @map("avatar_url")
  role      String   @default("user")
  preferences Json?  @map("preferences") // Stores notification & security preferences
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user                      User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasksCreated              Task[]                   @relation("TaskCreatedBy")
  tasksAssigned             Task[]                   @relation("TaskAssignedTo")
  tasksRejected             Task[]                   @relation("TaskRejectedBy")
  tasksCompleted            Task[]                   @relation("TaskCompletedBy")
  inventoryInvoicesCreated  InventoryInvoice[]       @relation("InvoiceCreatedBy")
  monthlyWastageCreated     MonthlyWastage[]
  wasteTrackingReported     WasteTracking[]
  workersCreated            Worker[]                 @relation("WorkerCreatedBy")
  workAssignmentsCreated    WorkAssignment[]         @relation("AssignmentCreatedBy")
  lineAssignees             LineAssignee[]
  googleSheetConnections    GoogleSheetConnection[]

  // Worker relationship (if this profile is linked to a worker)
  linkedWorker              Worker?                  @relation("WorkerProfile")

  // Payroll relations
  payrollPeriodsCreated     PayrollPeriod[]          @relation("PayrollPeriodCreatedBy")
  workerPaymentsCreated     WorkerPayment[]          @relation("WorkerPaymentCreatedBy")
  payrollAdjustmentsCreated PayrollAdjustment[]      @relation("AdjustmentCreatedBy")

  @@map("profiles")
}

// ==========================================
// COMPANY SETTINGS
// ==========================================
model CompanySettings {
  id               String   @id @default(uuid())
  companyName      String   @default("NNS Enterprise") @map("company_name")
  address          String?
  contactNumbers   String[] @map("contact_numbers")
  website          String?  @default("nns.lk")
  registeredNumber String?  @map("registered_number")
  bankDetails      Json?    @map("bank_details")
  pricingTiers     Json?    @map("pricing_tiers")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("company_settings")
}

// ==========================================
// EMAIL SETTINGS (System-wide)
// ==========================================
model EmailSettings {
  id            String   @id @default(uuid())
  provider      String   @default("resend") // 'resend' or 'smtp'
  isActive      Boolean  @default(true) @map("is_active")
  
  // Resend Configuration
  resendApiKey  String?  @map("resend_api_key") // Encrypted
  
  // SMTP Configuration (all encrypted)
  smtpHost      String?  @map("smtp_host")
  smtpPort      Int?     @map("smtp_port")
  smtpSecure    Boolean  @default(true) @map("smtp_secure")
  smtpUser      String?  @map("smtp_user")
  smtpPassword  String?  @map("smtp_password") // Encrypted
  
  // Common Settings
  fromEmail     String   @default("noreply@nns.lk") @map("from_email")
  fromName      String   @default("NNS Enterprise") @map("from_name")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("email_settings")
}

// ==========================================
// LOGIN HISTORY (Security Audit)
// ==========================================
model LoginHistory {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  location    String?  // City, Country derived from IP
  device      String?  // Device type parsed from user agent
  success     Boolean  @default(true)
  failReason  String?  @map("fail_reason") // 'invalid_password', 'account_locked', '2fa_failed'
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("login_history")
}

// ==========================================
// INVENTORY MANAGEMENT
// ==========================================
model InventoryItem {
  id           String   @id @default(uuid())
  name         String   @unique
  unit         String
  currentStock Decimal  @default(0) @map("current_stock")
  drumSize     Decimal? @map("drum_size")
  reorderLevel Decimal  @default(0) @map("reorder_level")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  inventoryInvoiceItems  InventoryInvoiceItem[]
  drumTracking           DrumTracking[]
  monthlyWastage         MonthlyWastage[]
  wasteTracking          WasteTracking[]
  monthlyInventoryUsages MonthlyInventoryUsage[]

  @@map("inventory_items")
}

// Monthly inventory usage tracking to prevent duplicate deductions on Google Sheet syncs
model MonthlyInventoryUsage {
  id            String   @id @default(uuid())
  itemId        String   @map("item_id")
  month         Int
  year          Int
  totalUsed     Decimal  @default(0) @map("total_used")
  lastSyncedAt  DateTime @default(now()) @map("last_synced_at")
  connectionId  String?  @map("connection_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  item InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([itemId, month, year])
  @@index([month, year])
  @@map("monthly_inventory_usage")
}

model InventoryInvoice {
  id                String   @id @default(uuid())
  invoiceNumber     String   @unique @map("invoice_number")
  warehouse         String?
  date              DateTime @default(now()) @db.Date
  issuedBy          String?  @map("issued_by")
  drawnBy           String?  @map("drawn_by")
  invoiceImageUrl   String?  @map("invoice_image_url")
  createdById       String?  @map("created_by")
  autoInvoiceNumber String?  @unique @map("auto_invoice_number")
  ocrProcessed      Boolean  @default(false) @map("ocr_processed")
  ocrImageUrl       String?  @map("ocr_image_url")
  totalItems        Int      @default(0) @map("total_items")
  status            String   @default("draft")
  
  // Payment tracking fields (for inventory purchases that need payment)
  paymentStatus     String   @default("not_applicable") @map("payment_status") // 'not_applicable', 'unpaid', 'partial', 'paid'
  totalCost         Decimal? @map("total_cost")
  paidAmount        Decimal  @default(0) @map("paid_amount")
  currencyCode      String?  @map("currency_code")
  dueDate           DateTime? @map("due_date") @db.Date
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  createdBy Profile?               @relation("InvoiceCreatedBy", fields: [createdById], references: [id])
  items     InventoryInvoiceItem[]

  @@map("inventory_invoices")
}

model InventoryInvoiceItem {
  id                String   @id @default(uuid())
  invoiceId         String?  @map("invoice_id")
  itemId            String?  @map("item_id")
  description       String?
  unit              String?
  quantityRequested Decimal? @map("quantity_requested")
  quantityIssued    Decimal? @map("quantity_issued")
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  invoice InventoryInvoice? @relation(fields: [invoiceId], references: [id])
  item    InventoryItem?    @relation(fields: [itemId], references: [id])

  @@map("inventory_invoice_items")
}

// ==========================================
// DRUM TRACKING
// ==========================================
model DrumTracking {
  id              String   @id @default(uuid())
  drumNumber      String   @map("drum_number")
  itemId          String?  @map("item_id")
  initialQuantity Decimal  @map("initial_quantity")
  currentQuantity Decimal  @map("current_quantity")
  status          String   @default("active")
  receivedDate    DateTime @default(now()) @map("received_date") @db.Date
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  item                 InventoryItem?         @relation(fields: [itemId], references: [id])
  drumUsages           DrumUsage[]
  drumTrackingHistories DrumTrackingHistory[]

  @@map("drum_tracking")
}

// Audit trail for drum quantity changes
model DrumTrackingHistory {
  id               String   @id @default(uuid())
  drumId           String   @map("drum_id")
  action           String   // 'created', 'usage_added', 'quantity_adjusted', 'status_changed'
  previousQuantity Decimal? @map("previous_quantity")
  newQuantity      Decimal  @map("new_quantity")
  quantityChange   Decimal  @map("quantity_change")
  previousStatus   String?  @map("previous_status")
  newStatus        String?  @map("new_status")
  lineDetailsId    String?  @map("line_details_id")
  syncConnectionId String?  @map("sync_connection_id")
  notes            String?
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  drum DrumTracking @relation(fields: [drumId], references: [id], onDelete: Cascade)

  @@index([drumId])
  @@index([createdAt])
  @@index([action])
  @@map("drum_tracking_history")
}

model DrumUsage {
  id                String   @id @default(uuid())
  drumId            String?  @map("drum_id")
  lineDetailsId     String?  @map("line_details_id")
  quantityUsed      Decimal  @map("quantity_used")
  usageDate         DateTime @default(now()) @map("usage_date") @db.Date
  cableStartPoint   Decimal  @default(0) @map("cable_start_point")
  cableEndPoint     Decimal  @default(0) @map("cable_end_point")
  wastageCalculated Decimal  @default(0) @map("wastage_calculated")
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  drum        DrumTracking? @relation(fields: [drumId], references: [id])
  lineDetails LineDetails?  @relation(fields: [lineDetailsId], references: [id])

  @@map("drum_usage")
}

// ==========================================
// LINE DETAILS (Main fiber line installation records)
// ==========================================
model LineDetails {
  id           String    @id @default(uuid())
  taskId       String?   @map("task_id")
  date         DateTime  @default(now()) @db.Date
  telephoneNo  String    @map("telephone_no")
  dp           String
  powerDp      Decimal?  @map("power_dp")
  powerInbox   Decimal?  @map("power_inbox")
  name         String?
  address      String?
  cableStart   Decimal   @default(0) @map("cable_start")
  cableMiddle  Decimal   @default(0) @map("cable_middle")
  cableEnd     Decimal   @default(0) @map("cable_end")
  // f1, g1, total_cable are generated columns in PostgreSQL
  // We'll compute them in application code
  wastage      Decimal   @default(0)
  retainers    Int       @default(0)
  lHook        Int       @default(0) @map("l_hook")
  topBolt      Int       @default(0) @map("top_bolt")
  cHook        Int       @default(1) @map("c_hook")
  fiberRosette Int       @default(1) @map("fiber_rosette")
  internalWire Decimal   @default(0) @map("internal_wire")
  sRosette     Int       @default(0) @map("s_rosette")
  fac          Int       @default(2)
  casing       Decimal   @default(0)
  cTie         Int       @default(0) @map("c_tie")
  cClip        Int       @default(0) @map("c_clip")
  conduit      Decimal   @default(0)
  tagTie       Int       @default(1) @map("tag_tie")
  ont          String?
  voiceTestNo  String?   @map("voice_test_no")
  stb          String?
  flexible     Int       @default(2)
  rj45         Int       @default(0)
  cat5         Decimal   @default(0)
  pole67       Int       @default(0) @map("pole_67")
  pole         Int       @default(0)
  concreteNail Int       @default(0) @map("concrete_nail")
  rollPlug     Int       @default(0) @map("roll_plug")
  uClip        Int       @default(0) @map("u_clip")
  socket       Int       @default(0)
  bend         Int       @default(0)
  rj11         Int       @default(0)
  rj12         Int       @default(0)
  drumNumber   String?   @map("drum_number")
  phoneNumber  String?   @map("phone_number")
  wastageInput Decimal?  @map("wastage_input")
  ontSerial    String?   @map("ont_serial")
  voiceTestNoNew String? @map("voice_test_no_new")
  stbSerial    String?   @map("stb_serial")
  drumNumberNew String?  @map("drum_number_new")
  completedDate DateTime? @map("completed_date") @db.Date
  status       String?
  nutBolt      Int       @default(0) @map("nut_bolt")
  screwNail    Int       @default(0) @map("screw_nail")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  task            Task?            @relation(fields: [taskId], references: [id])
  drumUsages      DrumUsage[]
  workAssignments WorkAssignment[]
  lineAssignees   LineAssignee[]

  @@unique([telephoneNo, date])
  @@map("line_details")
}

// ==========================================
// TASKS (Work order management)
// ==========================================
model Task {
  id                  String    @id @default(uuid())
  addedDate           DateTime  @default(now()) @map("added_date") @db.Date
  telephoneNo         String    @map("telephone_no")
  dp                  String
  contactNo           String?   @map("contact_no")
  customerName        String?   @map("customer_name")
  address             String?
  status              String    @default("pending")
  connectionTypes     String[]  @map("connection_types")
  connectionTypeMain  String    @default("new") @map("connection_type_main")
  rejectionReason     String?   @map("rejection_reason")
  rejectedById        String?   @map("rejected_by")
  rejectedAt          DateTime? @map("rejected_at")
  completedAt         DateTime? @map("completed_at")
  createdById         String?   @map("created_by")
  taskDate            DateTime  @default(now()) @map("task_date") @db.Date
  connectionTypeNew   String    @default("New") @map("connection_type_new")
  connectionServices  String[]  @default([]) @map("connection_services")
  assignedToId        String?   @map("assigned_to")
  completedById       String?   @map("completed_by")
  lineDetailsId       String?   @map("line_details_id")
  notes               String?
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  rejectedBy  Profile?      @relation("TaskRejectedBy", fields: [rejectedById], references: [id])
  completedBy Profile?      @relation("TaskCompletedBy", fields: [completedById], references: [id])
  assignedTo  Profile?      @relation("TaskAssignedTo", fields: [assignedToId], references: [id])
  createdBy   Profile?      @relation("TaskCreatedBy", fields: [createdById], references: [id])
  lineDetails LineDetails[]

  @@map("tasks")
}

// ==========================================
// WORKERS & WORK ASSIGNMENTS
// ==========================================
model Worker {
  id          String   @id @default(uuid())
  fullName    String   @map("full_name")
  employeeNo  String?  @unique @map("employee_no")
  phoneNumber String?  @map("phone_number")
  email       String?
  role        String   @default("technician")
  status      String   @default("active")
  profileId   String?  @unique @map("profile_id")
  notes       String?
  createdById String?  @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Payroll fields
  paymentType     String   @default("per_line") @map("payment_type") // per_line, fixed_monthly
  perLineRate     Decimal? @map("per_line_rate") @db.Decimal(10, 2) // Rate per completed line
  monthlyRate     Decimal? @map("monthly_rate") @db.Decimal(10, 2) // Fixed monthly salary
  bankName        String?  @map("bank_name")
  bankBranch      String?  @map("bank_branch")
  accountNumber   String?  @map("account_number")
  accountName     String?  @map("account_name")

  // Relations
  profile         Profile?         @relation("WorkerProfile", fields: [profileId], references: [id])
  createdBy       Profile?         @relation("WorkerCreatedBy", fields: [createdById], references: [id])
  workAssignments WorkAssignment[]
  payments        WorkerPayment[]

  @@map("workers")
}

model WorkAssignment {
  id           String   @id @default(uuid())
  lineId       String   @map("line_id")
  workerId     String   @map("worker_id")
  assignedDate DateTime @map("assigned_date") @db.Date
  createdById  String   @map("created_by")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  line      LineDetails @relation(fields: [lineId], references: [id], onDelete: Cascade)
  worker    Worker      @relation(fields: [workerId], references: [id], onDelete: Cascade)
  createdBy Profile     @relation("AssignmentCreatedBy", fields: [createdById], references: [id])

  @@map("work_assignments")
}

model LineAssignee {
  id         String   @id @default(uuid())
  lineId     String   @map("line_id")
  userId     String   @map("user_id")
  assignedAt DateTime @default(now()) @map("assigned_at")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  line LineDetails @relation(fields: [lineId], references: [id])
  user Profile     @relation(fields: [userId], references: [id])

  @@map("line_assignees")
}

// ==========================================
// INVOICING
// ==========================================
model GeneratedInvoice {
  id             String   @id @default(uuid())
  invoiceNumber  String   @map("invoice_number")
  month          Int?
  year           Int?
  invoiceType    String?  @map("invoice_type")
  totalAmount    Decimal? @map("total_amount")
  pdfUrl         String?  @map("pdf_url")
  invoiceDate    DateTime? @map("invoice_date") @db.Date
  jobMonth       String?  @map("job_month")
  lineCount      Decimal? @map("line_count")
  status         String?
  lineDetailsIds Json?    @map("line_details_ids")
  
  // Payment tracking fields
  paymentStatus  String   @default("unpaid") @map("payment_status") // 'unpaid', 'partial', 'paid'
  paidAmount     Decimal  @default(0) @map("paid_amount")
  currencyCode   String?  @map("currency_code") // ISO currency code
  dueDate        DateTime? @map("due_date") @db.Date
  
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("generated_invoices")
}

// ==========================================
// WASTAGE TRACKING
// ==========================================
model MonthlyWastage {
  id          String   @id @default(uuid())
  month       Int?
  year        Int?
  itemId      String?  @map("item_id")
  quantity    Decimal?
  createdById String?  @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  createdBy Profile?       @relation(fields: [createdById], references: [id])
  item      InventoryItem? @relation(fields: [itemId], references: [id])

  @@map("monthly_wastage")
}

model WasteTracking {
  id           String   @id @default(uuid())
  itemId       String?  @map("item_id")
  quantity     Decimal
  wasteReason  String?  @map("waste_reason")
  wasteDate    DateTime @default(now()) @map("waste_date") @db.Date
  reportedById String?  @map("reported_by")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  item       InventoryItem? @relation(fields: [itemId], references: [id])
  reportedBy Profile?       @relation(fields: [reportedById], references: [id])

  @@map("waste_tracking")
}

// ==========================================
// NOTIFICATIONS
// ==========================================
model Notification {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  title     String
  message   String
  type      String   @default("info") // info, success, warning, error
  category  String   @default("system") // line_added, task_completed, invoice_generated, report_ready, inventory_low, system
  isRead    Boolean  @default(false) @map("is_read")
  actionUrl String?  @map("action_url")
  metadata  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// ==========================================
// CONTENT MANAGEMENT (Blog & Posts)
// ==========================================
model Blog {
  id               Int       @id @default(autoincrement())
  title            String
  content          String
  excerpt          String?
  author           String
  category         String?
  tags             String[]
  featuredImageUrl String?   @map("featured_image_url")
  slug             String?   @unique
  metaDescription  String?   @map("meta_description")
  readingTime      Int?      @map("reading_time")
  status           String    @default("active") // active, disabled
  publishedAt      DateTime? @map("published_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@map("blogs")
}

model Post {
  id               Int      @id @default(autoincrement())
  title            String
  content          String
  excerpt          String?
  author           String
  category         String?
  tags             String[]
  featuredImageUrl String?  @map("featured_image_url")
  status           String   @default("active") // active, disabled
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("posts")
}

// ==========================================
// JOB VACANCIES
// ==========================================
model JobVacancy {
  id               Int       @id @default(autoincrement())
  title            String
  description      String
  requirements     String?
  responsibilities String?
  department       String?
  location         String?
  employmentType   String    @default("full-time") @map("employment_type") // full-time, part-time, contract, internship
  salaryRange      String?   @map("salary_range")
  experienceLevel  String?   @map("experience_level")
  skills           String[]
  benefits         String[]
  applicationEmail String?   @map("application_email")
  applicationUrl   String?   @map("application_url")
  endDate          DateTime  @map("end_date") @db.Date
  status           String    @default("active") // active, disabled
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@map("job_vacancies")
}

// ==========================================
// GOOGLE SHEETS INTEGRATION
// ==========================================
model GoogleSheetConnection {
  id          String    @id @default(uuid())
  month       Int
  year        Int
  sheetUrl    String    @map("sheet_url")
  sheetId     String?   @map("sheet_id")
  sheetName   String?   @map("sheet_name")
  sheetTab    String?   @map("sheet_tab")
  createdById String?   @map("created_by")
  lastSynced  DateTime? @map("last_synced")
  status      String    @default("active")
  recordCount Int       @default(0) @map("record_count")
  metadata    Json      @default("{}")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  createdBy Profile? @relation(fields: [createdById], references: [id])

  @@index([year, month])
  @@map("google_sheet_connections")
}

// ==========================================
// ACCOUNTING MODULE
// ==========================================

// Currency support for multi-currency accounting
model Currency {
  id           String   @id @default(uuid())
  code         String   @unique // ISO 4217 code (USD, LKR, EUR, etc.)
  name         String
  symbol       String
  exchangeRate Decimal  @default(1) @map("exchange_rate") // Rate to base currency
  isBase       Boolean  @default(false) @map("is_base") // Is this the base/reporting currency
  isActive     Boolean  @default(true) @map("is_active")
  decimalPlaces Int     @default(2) @map("decimal_places")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  chartOfAccounts  ChartOfAccount[]
  journalEntries   JournalEntry[]
  invoicePayments  InvoicePayment[]

  @@map("currencies")
}

// Chart of Accounts - the foundation of double-entry accounting
model ChartOfAccount {
  id              String   @id @default(uuid())
  code            String   @unique // Account code (e.g., 1000, 1100, 2000)
  name            String
  description     String?
  category        String   // Asset, Liability, Equity, Revenue, Expense
  subCategory     String?  @map("sub_category") // e.g., Current Asset, Fixed Asset, Operating Revenue
  parentId        String?  @map("parent_id")
  currencyId      String?  @map("currency_id")
  isActive        Boolean  @default(true) @map("is_active")
  isSystemAccount Boolean  @default(false) @map("is_system_account") // Protected system accounts
  normalBalance   String   @default("debit") @map("normal_balance") // 'debit' or 'credit'
  openingBalance  Decimal  @default(0) @map("opening_balance")
  currentBalance  Decimal  @default(0) @map("current_balance")
  displayOrder    Int      @default(0) @map("display_order")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Self-relation for hierarchical accounts
  parent   ChartOfAccount?  @relation("AccountHierarchy", fields: [parentId], references: [id])
  children ChartOfAccount[] @relation("AccountHierarchy")
  currency Currency?        @relation(fields: [currencyId], references: [id])

  // Journal entry lines
  journalEntryLines JournalEntryLine[]

  // Default account mappings
  defaultForReceivables AccountingSettings[] @relation("DefaultReceivablesAccount")
  defaultForPayables    AccountingSettings[] @relation("DefaultPayablesAccount")
  defaultForCash        AccountingSettings[] @relation("DefaultCashAccount")
  defaultForRevenue     AccountingSettings[] @relation("DefaultRevenueAccount")
  defaultForExpense     AccountingSettings[] @relation("DefaultExpenseAccount")

  @@index([category])
  @@index([parentId])
  @@map("chart_of_accounts")
}

// Accounting Periods for financial reporting
model AccountingPeriod {
  id          String   @id @default(uuid())
  name        String   // e.g., "January 2026", "Q1 2026", "FY 2025-2026"
  periodType  String   @map("period_type") // 'monthly', 'quarterly', 'yearly'
  startDate   DateTime @map("start_date") @db.Date
  endDate     DateTime @map("end_date") @db.Date
  isClosed    Boolean  @default(false) @map("is_closed")
  closedAt    DateTime? @map("closed_at")
  closedById  String?  @map("closed_by")
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  journalEntries JournalEntry[]

  @@unique([periodType, startDate, endDate])
  @@map("accounting_periods")
}

// Journal Entry Header
model JournalEntry {
  id              String   @id @default(uuid())
  entryNumber     String   @unique @map("entry_number") // Auto-generated: JE-2026-0001
  date            DateTime @db.Date
  description     String
  reference       String?  // External reference (invoice number, payment ref, etc.)
  referenceType   String?  @map("reference_type") // 'invoice_payment', 'manual', 'reversal', etc.
  referenceId     String?  @map("reference_id") // ID of related record
  periodId        String?  @map("period_id")
  currencyId      String?  @map("currency_id")
  exchangeRate    Decimal  @default(1) @map("exchange_rate")
  status          String   @default("draft") // 'draft', 'pending', 'approved', 'reversed'
  totalDebit      Decimal  @default(0) @map("total_debit")
  totalCredit     Decimal  @default(0) @map("total_credit")
  isReversed      Boolean  @default(false) @map("is_reversed")
  reversedEntryId String?  @map("reversed_entry_id") // Points to the reversal entry
  originalEntryId String?  @map("original_entry_id") // If this is a reversal, points to original
  createdById     String?  @map("created_by")
  approvedById    String?  @map("approved_by")
  approvedAt      DateTime? @map("approved_at")
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  period    AccountingPeriod? @relation(fields: [periodId], references: [id])
  currency  Currency?         @relation(fields: [currencyId], references: [id])
  lines     JournalEntryLine[]

  @@index([date])
  @@index([status])
  @@index([referenceType, referenceId])
  @@map("journal_entries")
}

// Journal Entry Line Items
model JournalEntryLine {
  id            String   @id @default(uuid())
  journalEntryId String  @map("journal_entry_id")
  accountId     String   @map("account_id")
  description   String?
  debitAmount   Decimal  @default(0) @map("debit_amount")
  creditAmount  Decimal  @default(0) @map("credit_amount")
  lineOrder     Int      @default(0) @map("line_order")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  journalEntry JournalEntry   @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account      ChartOfAccount @relation(fields: [accountId], references: [id])

  @@index([accountId])
  @@map("journal_entry_lines")
}

// Invoice Payment tracking
model InvoicePayment {
  id              String   @id @default(uuid())
  paymentNumber   String   @unique @map("payment_number") // Auto: PAY-2026-0001
  invoiceId       String   @map("invoice_id")
  invoiceType     String   @map("invoice_type") // 'generated' or 'inventory'
  paymentDate     DateTime @map("payment_date") @db.Date
  amount          Decimal
  currencyId      String?  @map("currency_id")
  exchangeRate    Decimal  @default(1) @map("exchange_rate")
  amountInBase    Decimal  @map("amount_in_base") // Amount in base currency
  paymentMethod   String   @map("payment_method") // 'cash', 'bank_transfer', 'cheque', 'card'
  reference       String?  // Check number, transaction ID, etc.
  bankAccountId   String?  @map("bank_account_id") // Which bank account received payment
  journalEntryId  String?  @map("journal_entry_id") // Auto-generated journal entry
  status          String   @default("completed") // 'pending', 'completed', 'cancelled'
  notes           String?
  createdById     String?  @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  currency Currency? @relation(fields: [currencyId], references: [id])

  @@index([invoiceId, invoiceType])
  @@index([paymentDate])
  @@map("invoice_payments")
}

// Accounting Settings for customization
model AccountingSettings {
  id                        String   @id @default(uuid())
  fiscalYearStart           Int      @default(1) @map("fiscal_year_start") // Month (1-12)
  baseCurrencyId            String?  @map("base_currency_id")
  defaultReceivablesAccountId String? @map("default_receivables_account_id")
  defaultPayablesAccountId  String?  @map("default_payables_account_id")
  defaultCashAccountId      String?  @map("default_cash_account_id")
  defaultRevenueAccountId   String?  @map("default_revenue_account_id")
  defaultExpenseAccountId   String?  @map("default_expense_account_id")
  autoGenerateJournalEntries Boolean @default(true) @map("auto_generate_journal_entries")
  requireApproval           Boolean  @default(false) @map("require_approval")
  allowBackdatedEntries     Boolean  @default(true) @map("allow_backdated_entries")
  entryNumberPrefix         String   @default("JE") @map("entry_number_prefix")
  paymentNumberPrefix       String   @default("PAY") @map("payment_number_prefix")
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")

  // Relations
  defaultReceivablesAccount ChartOfAccount? @relation("DefaultReceivablesAccount", fields: [defaultReceivablesAccountId], references: [id])
  defaultPayablesAccount    ChartOfAccount? @relation("DefaultPayablesAccount", fields: [defaultPayablesAccountId], references: [id])
  defaultCashAccount        ChartOfAccount? @relation("DefaultCashAccount", fields: [defaultCashAccountId], references: [id])
  defaultRevenueAccount     ChartOfAccount? @relation("DefaultRevenueAccount", fields: [defaultRevenueAccountId], references: [id])
  defaultExpenseAccount     ChartOfAccount? @relation("DefaultExpenseAccount", fields: [defaultExpenseAccountId], references: [id])

  @@map("accounting_settings")
}

// ==========================================
// LEGACY TABLE (May not be actively used)
// ==========================================
model LineEntry {
  id          String   @id @default(uuid())
  date        DateTime @db.Date
  phoneNumber String   @map("phone_number")
  dp          String
  powerDp     Decimal  @map("power_dp")
  powerInbox  Decimal  @map("power_inbox")
  name        String
  address     String
  cableStart  Decimal  @map("cable_start")
  cableMiddle Decimal  @map("cable_middle")
  cableEnd    Decimal  @map("cable_end")
  f1          Decimal
  g1          Decimal
  total       Decimal
  wastage     Decimal
  userId      String?  @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("line_entries")
}

// ==========================================
// PAYROLL SYSTEM
// ==========================================
model PayrollPeriod {
  id          String    @id @default(uuid())
  name        String    // e.g., "January 2026 Payroll"
  month       Int       // 1-12
  year        Int
  startDate   DateTime  @map("start_date") @db.Date
  endDate     DateTime  @map("end_date") @db.Date
  status      String    @default("draft") // draft, processing, approved, paid
  totalAmount Decimal   @default(0) @map("total_amount") @db.Decimal(12, 2)
  paidDate    DateTime? @map("paid_date")
  createdById String    @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  createdBy Profile         @relation("PayrollPeriodCreatedBy", fields: [createdById], references: [id])
  payments  WorkerPayment[]

  @@unique([month, year])
  @@map("payroll_periods")
}

model WorkerPayment {
  id              String   @id @default(uuid())
  payrollPeriodId String   @map("payroll_period_id")
  workerId        String   @map("worker_id")
  
  // Payment details
  paymentType     String   @map("payment_type") // per_line, fixed_monthly
  linesCompleted  Int      @default(0) @map("lines_completed")
  perLineRate     Decimal? @map("per_line_rate") @db.Decimal(10, 2)
  baseAmount      Decimal  @map("base_amount") @db.Decimal(10, 2) // Calculated base (lines * rate or monthly)
  bonusAmount     Decimal  @default(0) @map("bonus_amount") @db.Decimal(10, 2)
  deductionAmount Decimal  @default(0) @map("deduction_amount") @db.Decimal(10, 2)
  netAmount       Decimal  @map("net_amount") @db.Decimal(10, 2) // base + bonus - deductions
  
  // Status tracking
  status          String   @default("calculated") // calculated, approved, paid
  paidAt          DateTime? @map("paid_at")
  paymentMethod   String?  @map("payment_method") // bank_transfer, cash, cheque
  paymentRef      String?  @map("payment_ref")
  notes           String?
  
  // Metadata
  createdById     String   @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  payrollPeriod PayrollPeriod        @relation(fields: [payrollPeriodId], references: [id], onDelete: Cascade)
  worker        Worker               @relation(fields: [workerId], references: [id], onDelete: Cascade)
  createdBy     Profile              @relation("WorkerPaymentCreatedBy", fields: [createdById], references: [id])
  adjustments   PayrollAdjustment[]

  @@unique([payrollPeriodId, workerId])
  @@map("worker_payments")
}

model PayrollAdjustment {
  id              String   @id @default(uuid())
  workerPaymentId String   @map("worker_payment_id")
  type            String   // bonus, deduction
  category        String   // performance_bonus, attendance_bonus, overtime, tax, advance, fine, other
  description     String
  amount          Decimal  @db.Decimal(10, 2)
  createdById     String   @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  workerPayment WorkerPayment @relation(fields: [workerPaymentId], references: [id], onDelete: Cascade)
  createdBy     Profile       @relation("AdjustmentCreatedBy", fields: [createdById], references: [id])

  @@map("payroll_adjustments")
}


model PayrollRule {
  id          String   @id @default(uuid())
  name        String
  type        String   // bonus, deduction
  category    String   // epf, etf, tax, fine, etc.
  percentage  Decimal? @db.Decimal(5, 2)
  fixedAmount Decimal? @map("fixed_amount") @db.Decimal(10, 2)
  enabled     Boolean  @default(true)
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("payroll_rules")
}
